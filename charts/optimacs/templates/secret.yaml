{{/*
Renders the complete ac_server.conf as a Secret so that the DB password
is never stored in a ConfigMap (which has no encryption at rest).

TLS certificates are stored in a separate Secret referenced by
.Values.tlsSecret.name (created out-of-band — see NOTES.txt).

When stepca.url is set, certificate signing is delegated to step-ca via
the JWK provisioner.  The provisioner key is mounted from the Secret
referenced by .Values.stepca.provisioner.secretName.
*/}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "ac-server.configSecretName" . }}
  labels:
    {{- include "ac-server.labels" . | nindent 4 }}
type: Opaque
stringData:
  ac_server.conf: |
    # Server TLS cert — mounted from Secret {{ .Values.tlsSecret.name }}
    cert_file   = /etc/ac-server/tls/server.crt
    key_file    = /etc/ac-server/tls/server.key
    key_pass    = *none*
    ca_file     = /etc/ac-server/tls/rootCA.crt
    {{- if not .Values.stepca.url }}
    # CA private key — used only when step-ca is not configured
    ca_key      = /etc/ac-server/tls/rootCA.key
    {{- end }}

    # Initial CN used by unregistered devices
    init_cn     = {{ .Values.config.initCn }}

    # Database — host resolved via optimacs.mysql.host helper
    db_schema   = {{ .Values.config.dbSchema }}
    db_host     = {{ include "optimacs.mysql.host" . }}
    db_user     = {{ include "optimacs.mysql.user" . }}
    db_pass     = {{ required "db.password is required" .Values.db.password }}
    db_name     = {{ include "optimacs.mysql.database" . }}

    # Server bind address and port
    server_host = {{ .Values.config.serverHost }}
    server_port = {{ .Values.config.serverPort }}

    # Persistent volume mount paths (must match deployment.yaml)
    xml_dir     = /var/ac-server/peers/
    fw_dir      = /var/ac-server/firmware/
    img_dir     = /var/ac-server/images/

    {{- $redisUrl := include "optimacs.redis.url" . }}
    {{- if $redisUrl }}
    # Redis — config-proto cache
    redis_url   = {{ $redisUrl }}
    redis_ttl   = {{ .Values.redis.cacheTtl }}
    {{- end }}

    {{- if .Values.metrics.enabled }}
    # Prometheus metrics listener
    metrics_port = {{ .Values.metrics.port }}
    {{- end }}

    # USP / TR-369 ────────────────────────────────────────────────────────────
    usp_ws_port     = {{ .Values.usp.ws.port }}
    usp_endpoint_id = {{ .Values.usp.endpointId }}
    mqtt_client_id  = {{ .Values.usp.mqttClientId }}
    {{- if .Values.usp.mqtt.url }}
    mqtt_url        = {{ .Values.usp.mqtt.url }}
    {{- else if .Values.emqx.enabled }}
    mqtt_url        = mqtt://{{ include "ac-server.fullname" . }}-emqx:1883
    {{- end }}

    {{- $stepcaUrl := .Values.stepca.url }}
    {{- if and .Values.stepca.enabled (not $stepcaUrl) }}
    {{-   $stepcaUrl = printf "https://%s-step-certificates:9000" (include "ac-server.fullname" .) }}
    {{- end }}
    {{- if $stepcaUrl }}
    # step-ca PKI ─────────────────────────────────────────────────────────────
    stepca_url          = {{ $stepcaUrl }}
    {{- if .Values.stepca.fingerprint }}
    stepca_fingerprint  = {{ .Values.stepca.fingerprint }}
    {{- end }}
    stepca_kid          = {{ required "stepca.kid is required when step-ca is configured" .Values.stepca.kid }}
    stepca_key_pem_file = /etc/ac-server/stepca/provisioner.key
    {{- if .Values.stepca.skipVerify }}
    stepca_skip_verify  = true
    {{- end }}
    {{- end }}
