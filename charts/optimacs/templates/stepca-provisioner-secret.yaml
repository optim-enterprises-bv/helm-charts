{{/*
Kubernetes Secret holding the step-ca JWK provisioner private key.

ac-server uses this key to sign one-time tokens (OTTs) when calling
the step-ca /1.0/sign endpoint to issue device client certificates.

The key PEM is supplied via `.Values.stepca.keyPem` at install time:

  helm install optimacs ./helm/ac-server \
    --set stepca.kid=<provisioner-kid> \
    --set-file stepca.keyPem=/path/to/provisioner-ec-p256.key

This Secret is only created when a step-ca URL is configured
(either the sub-chart or an external CA).
*/}}
{{- $stepcaUrl := .Values.stepca.url }}
{{- if and .Values.stepca.enabled (not $stepcaUrl) }}
{{-   $stepcaUrl = printf "https://%s-step-certificates:9000" (include "ac-server.fullname" .) }}
{{- end }}
{{- if $stepcaUrl }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "ac-server.fullname" . }}-stepca-provisioner
  labels:
    {{- include "ac-server.labels" . | nindent 4 }}
type: Opaque
stringData:
  provisioner.key: |
    {{- required "stepca.keyPem (JWK provisioner private key PEM) is required when step-ca is configured" .Values.stepca.keyPem | nindent 4 }}
{{- end }}
