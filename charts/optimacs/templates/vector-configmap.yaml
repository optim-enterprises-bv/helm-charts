{{- if .Values.vector.enabled }}
{{- $redpandaBrokers := include "optimacs.telemetry.redpanda.brokers" . }}
{{- $vmUrl           := include "optimacs.telemetry.victoriametrics.url" . }}
{{- if and $redpandaBrokers $vmUrl }}
# Vector pipeline ConfigMap.
# Rendered with the correct Redpanda broker address and VictoriaMetrics endpoint.
# Mounted read-only into the Vector deployment at /etc/vector/vector.yaml.
#
# Pipeline:  Redpanda (Kafka) → route → VRL enrich → log_to_metric → prometheus_remote_write
#
# Metrics produced (all carry mac + endpoint_id labels):
#   optimacs_heartbeat_gauge{mac,endpoint_id,param_path}
#       — numeric value of any USP ValueChange heartbeat parameter
#   optimacs_device_events_total{mac,endpoint_id,event}
#       — counter incremented for every Boot! / OnBoardRequest lifecycle event
#   optimacs_config_changes_total{mac,endpoint_id}
#       — counter incremented for every config-push delivery confirmation
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "optimacs.vector.fullname" . }}-config
  labels:
    {{- include "ac-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: vector
data:
  vector.yaml: |
    # Vector telemetry pipeline — auto-generated by Helm.
    # Redpanda → route → log_to_metric → VictoriaMetrics (prometheus_remote_write).
    data_dir: /var/lib/vector

    # ── Sources ──────────────────────────────────────────────────────────────
    sources:
      kafka_telemetry:
        type: kafka
        bootstrap_servers: "{{ $redpandaBrokers }}"
        group_id: "vector-telemetry"
        topics:
          - "optimacs.heartbeat"
          - "optimacs.device.status"
          - "optimacs.config.change"
        auto_offset_reset: "latest"
        decoding:
          codec: json

    # ── Transforms ───────────────────────────────────────────────────────────
    transforms:

      # 1. Stash the Kafka topic and strip Kafka metadata fields.
      enrich:
        type: remap
        inputs: ["kafka_telemetry"]
        source: |
          .topic = string(.kafka_topic) ?? "unknown"
          del(.kafka_topic)
          del(.kafka_partition)
          del(.kafka_offset)
          del(.kafka_key)
          del(.kafka_headers)
          del(.kafka_timestamp)

      # 2. Route events by topic to separate sub-pipelines.
      route:
        type: route
        inputs: ["enrich"]
        route:
          heartbeat:     '.topic == "optimacs.heartbeat"'
          device_status: '.topic == "optimacs.device.status"'
          config_change: '.topic == "optimacs.config.change"'

      # 3a. Heartbeat — coerce the "value" field to a float so log_to_metric
      #     can produce a gauge.  Abort (drop) events where value is not numeric
      #     (e.g. string-only parameters like FirmwareVersion).
      heartbeat_parse:
        type: remap
        inputs: ["route.heartbeat"]
        source: |
          .value_num, err = to_float(.value)
          if err != null {
            abort
          }

      # 3b. Heartbeat → Prometheus gauge metric.
      #     param_path is carried as a label so a single metric name covers all
      #     USP parameters.  Example PromQL queries:
      #       optimacs_heartbeat_gauge{param_path=~".*UpTime.*"}
      #       optimacs_heartbeat_gauge{param_path=~".*LoadAverage.*"}
      #       optimacs_heartbeat_gauge{param_path=~".*FreeMemory.*"}
      heartbeat_metrics:
        type: log_to_metric
        inputs: ["heartbeat_parse"]
        metrics:
          - type: gauge
            field: value_num
            name: optimacs_heartbeat_gauge
            tags:
              mac:         "{{`{{mac}}`}}"
              endpoint_id: "{{`{{endpoint_id}}`}}"
              param_path:  "{{`{{param_path}}`}}"

      # 3c. Device lifecycle (Boot!, OnBoardRequest) → counter metric.
      device_status_metrics:
        type: log_to_metric
        inputs: ["route.device_status"]
        metrics:
          - type: counter
            field: mac
            name: optimacs_device_events_total
            increment_by_value: false
            tags:
              mac:         "{{`{{mac}}`}}"
              endpoint_id: "{{`{{endpoint_id}}`}}"
              event:       "{{`{{event}}`}}"

      # 3d. Config-push confirmation → counter metric.
      config_change_metrics:
        type: log_to_metric
        inputs: ["route.config_change"]
        metrics:
          - type: counter
            field: mac
            name: optimacs_config_changes_total
            increment_by_value: false
            tags:
              mac:         "{{`{{mac}}`}}"
              endpoint_id: "{{`{{endpoint_id}}`}}"

    # ── Sink ─────────────────────────────────────────────────────────────────
    sinks:
      victoriametrics:
        type: prometheus_remote_write
        inputs:
          - heartbeat_metrics
          - device_status_metrics
          - config_change_metrics
        endpoint: "{{ $vmUrl }}"
        {{- if .Values.victoriametrics.basicAuth.username }}
        auth:
          strategy: basic
          user: "{{ .Values.victoriametrics.basicAuth.username }}"
          password: "{{ .Values.victoriametrics.basicAuth.password }}"
        {{- end }}
        # Batch up to 1 s or 500 metric events to minimise remote-write calls.
        batch:
          timeout_secs: 1
          max_events: 500
{{- end }}
{{- end }}
