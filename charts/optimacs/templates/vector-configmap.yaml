{{- if .Values.vector.enabled }}
{{- $redpandaBrokers := include "optimacs.telemetry.redpanda.brokers" . }}
{{- $influxdbUrl     := include "optimacs.telemetry.influxdb.url" . }}
{{- if and $redpandaBrokers $influxdbUrl }}
# Vector pipeline ConfigMap.
# Rendered with the correct Redpanda broker address and InfluxDB endpoint.
# Mounted read-only into the Vector deployment at /etc/vector/vector.yaml.
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "optimacs.vector.fullname" . }}-config
  labels:
    {{- include "ac-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: vector
data:
  vector.yaml: |
    # Vector telemetry pipeline — auto-generated by Helm.
    # Redpanda → VRL transform → InfluxDB v2.
    data_dir: /var/lib/vector

    # ── Sources ──────────────────────────────────────────────────────────────
    sources:
      kafka_telemetry:
        type: kafka
        bootstrap_servers: "{{ $redpandaBrokers }}"
        group_id: "vector-telemetry"
        topics:
          - "optimacs.heartbeat"
          - "optimacs.device.status"
          - "optimacs.config.change"
        auto_offset_reset: "latest"
        decoding:
          codec: json

    # ── Transforms ───────────────────────────────────────────────────────────
    transforms:
      enrich:
        type: remap
        inputs: ["kafka_telemetry"]
        source: |
          # Derive InfluxDB measurement name from the source Kafka topic.
          topic = string(.kafka_topic) ?? "telemetry"
          if topic == "optimacs.heartbeat" {
            .measurement = "heartbeat"
          } else if topic == "optimacs.device.status" {
            .measurement = "device_status"
          } else {
            .measurement = "telemetry_event"
          }

          # Parse ISO-8601 timestamp from payload; fall back to Vector time.
          ts_str = string(.timestamp) ?? ""
          if ts_str != "" {
            parsed, err = parse_timestamp(ts_str, format: "%Y-%m-%dT%H:%M:%S%.3fZ")
            if err == null {
              .timestamp = parsed
            }
          }

          # Remove Kafka metadata — not needed in InfluxDB.
          del(.kafka_topic)
          del(.kafka_partition)
          del(.kafka_offset)
          del(.kafka_key)
          del(.kafka_headers)
          del(.kafka_timestamp)

    # ── Sinks ─────────────────────────────────────────────────────────────────
    sinks:
      influxdb_sink:
        type: influxdb_v2
        inputs: ["enrich"]
        endpoint: "{{ $influxdbUrl }}"
        org: "{{ .Values.influxdb2.adminUser.organization }}"
        bucket: "{{ .Values.influxdb2.adminUser.bucket }}"
        token: "{{ .Values.influxdb2.adminUser.token }}"
        # Dynamic measurement name from .measurement field set in transform.
        measurement: "{{ "{{" }} measurement {{ "}}" }}"
        # Fields listed here become InfluxDB tags (indexed strings).
        # All other non-timestamp fields become InfluxDB field values.
        tags:
          - mac
          - endpoint_id
          - event
          - param_path
{{- end }}
{{- end }}
