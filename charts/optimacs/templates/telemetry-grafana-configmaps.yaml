{{- if .Values.grafana.enabled }}
{{- $influxdbUrl := include "optimacs.telemetry.influxdb.url" . }}
# ── Grafana datasource ConfigMap ──────────────────────────────────────────────
# Labelled with grafana_datasource=1 so the grafana sidecar auto-loads it.
# ${INFLUXDB_TOKEN}, ${INFLUXDB_ORG}, and ${INFLUXDB_BUCKET} are substituted
# by Grafana at startup from the pod environment (set via grafana.env.*).
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ac-server.fullname" . }}-grafana-datasource
  labels:
    {{- include "ac-server.labels" . | nindent 4 }}
    grafana_datasource: "1"
data:
  influxdb-telemetry.yaml: |
    apiVersion: 1
    datasources:
      - name: InfluxDB-Telemetry
        type: influxdb
        access: proxy
        url: {{ $influxdbUrl | default "http://influxdb:8086" }}
        isDefault: true
        editable: false
        jsonData:
          version: Flux
          organization: "${INFLUXDB_ORG}"
          defaultBucket: "${INFLUXDB_BUCKET}"
          httpMode: POST
        secureJsonData:
          token: "${INFLUXDB_TOKEN}"
---
# ── Grafana dashboard ConfigMap ───────────────────────────────────────────────
# Labelled with grafana_dashboard=1 so the grafana sidecar auto-loads it.
# Dashboard UID: optimacs-telemetry-v1
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ac-server.fullname" . }}-grafana-dashboards
  labels:
    {{- include "ac-server.labels" . | nindent 4 }}
    grafana_dashboard: "1"
data:
  optimacs-telemetry.json: |
    {
      "__inputs": [
        {
          "name": "DS_INFLUXDB_TELEMETRY",
          "label": "InfluxDB-Telemetry",
          "description": "",
          "type": "datasource",
          "pluginId": "influxdb",
          "pluginName": "InfluxDB"
        }
      ],
      "__elements": {},
      "__requires": [
        { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "11.0.0" },
        { "type": "datasource", "id": "influxdb", "name": "InfluxDB", "version": "1.0.0" },
        { "type": "panel", "id": "timeseries", "name": "Time series", "version": "" },
        { "type": "panel", "id": "table", "name": "Table", "version": "" },
        { "type": "panel", "id": "stat", "name": "Stat", "version": "" }
      ],
      "annotations": { "list": [] },
      "description": "OptimACS device telemetry — heartbeat parameter changes and lifecycle events",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "panels": [
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
          "id": 10,
          "title": "Overview",
          "type": "row"
        },
        {
          "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] }
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 1 },
          "id": 1,
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
          "targets": [
            {
              "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
              "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"heartbeat\")\n  |> keep(columns: [\"mac\"])\n  |> distinct(column: \"mac\")\n  |> count()",
              "refId": "A"
            }
          ],
          "title": "Active Devices",
          "type": "stat"
        },
        {
          "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] } },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 1 },
          "id": 2,
          "options": { "colorMode": "background", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["count"], "fields": "", "values": false }, "textMode": "auto" },
          "targets": [
            {
              "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
              "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"heartbeat\")",
              "refId": "A"
            }
          ],
          "title": "Heartbeat Events",
          "type": "stat"
        },
        {
          "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [ { "color": "blue", "value": null } ] } },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 1 },
          "id": 3,
          "options": { "colorMode": "background", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["count"], "fields": "", "values": false }, "textMode": "auto" },
          "targets": [
            {
              "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
              "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"device_status\")",
              "refId": "A"
            }
          ],
          "title": "Lifecycle Events (Boot/OnBoard)",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 5 },
          "id": 11,
          "title": "Heartbeat — Parameter Changes",
          "type": "row"
        },
        {
          "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "auto", "spanNulls": false }
            },
            "overrides": []
          },
          "gridPos": { "h": 9, "w": 24, "x": 0, "y": 6 },
          "id": 4,
          "options": { "legend": { "calcs": [], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
          "targets": [
            {
              "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
              "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"heartbeat\")\n  |> filter(fn: (r) => r[\"param_path\"] =~ /Device.DeviceInfo/)\n  |> group(columns: [\"mac\", \"param_path\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: last, createEmpty: false)",
              "refId": "A"
            }
          ],
          "title": "Device Info Parameters — by Device",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 15 },
          "id": 12,
          "title": "Device Lifecycle Events",
          "type": "row"
        },
        {
          "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
          "fieldConfig": {
            "defaults": { "custom": { "align": "auto", "cellOptions": { "type": "auto" }, "inspect": false }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] } },
            "overrides": [
              { "matcher": { "id": "byName", "options": "_time" }, "properties": [ { "id": "displayName", "value": "Time" }, { "id": "custom.width", "value": 180 } ] },
              { "matcher": { "id": "byName", "options": "mac" }, "properties": [ { "id": "displayName", "value": "Device MAC" }, { "id": "custom.width", "value": 160 } ] }
            ]
          },
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 16 },
          "id": 5,
          "options": { "cellHeight": "sm", "footer": { "countRows": false, "fields": "", "reducer": ["sum"], "show": false }, "showHeader": true, "sortBy": [ { "desc": true, "displayName": "Time" } ] },
          "targets": [
            {
              "datasource": { "type": "influxdb", "uid": "${DS_INFLUXDB_TELEMETRY}" },
              "query": "from(bucket: v.defaultBucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r[\"_measurement\"] == \"device_status\")\n  |> pivot(rowKey: [\"_time\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> sort(columns: [\"_time\"], desc: true)\n  |> limit(n: 200)",
              "refId": "A"
            }
          ],
          "title": "Recent Lifecycle Events",
          "type": "table"
        }
      ],
      "refresh": "30s",
      "schemaVersion": 39,
      "tags": ["optimacs", "telemetry", "usp"],
      "templating": { "list": [] },
      "time": { "from": "now-6h", "to": "now" },
      "timepicker": {},
      "timezone": "browser",
      "title": "OptimACS — Device Telemetry",
      "uid": "optimacs-telemetry-v1",
      "version": 1
    }
{{- end }}
